language: cpp

compiler:
  - gcc
  - clang

before_install:
  - rm -rf boost_1_54_0
  - wget -c http://downloads.sourceforge.net/project/boost/boost/1.54.0/boost_1_54_0.tar.gz
  - tar zxf boost_1_54_0.tar.gz
  - mkdir boost_1_54_0/libs/di
  - cp -r doc example include test boost_1_54_0/libs/di
  - sudo cp tools/coveralls.sh /usr/bin
  - cd boost_1_54_0
  - if [ "$CXX" == "g++" ]; then sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y; fi
  #- if [ "$CXX" == "clang++" ]; then sudo add-apt-repository -y ppa:h-rayflood/llvm; fi
  - sudo apt-get update -qq
  - sudo apt-get -qq install valgrind
  - if [ "$CXX" == "g++" ]; then sudo apt-get install -qq g++-4.7; fi
  - if [ "$CXX" == "g++" ]; then sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-4.7 90; fi
  - if [ "$CXX" == "g++" ]; then ./bootstrap.sh --with-toolset=gcc; fi
  #- if [ "$CXX" == "clang++" ]; then sudo apt-get install --allow-unauthenticated -qq clang-3.4; fi
  #- if [ "$CXX" == "clang++" ]; then sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-3.4 90; fi
  - if [ "$CXX" == "clang++" ]; then ./bootstrap.sh --with-toolset=clang; fi

script:
  - pushd .
  - cd libs/di/example && ../../../b2 -j2
  - popd
  - pushd .
  - if [ "$CXX" == "g++" ]; then cd libs/di/test && ../../../b2 -j2 coverage ; fi
  - if [ "$CXX" == "clang++" ]; then cd libs/di/test && ../../../b2 -j2 ; fi
  - popd
  #- find bin.v2/libs/di -type f -executable | xargs -i% valgrind --leak-check=full --track-origins=yes --show-reachable=yes % >/dev/null

after_success:
  - if [ "$CXX" == "g++" ]; then cd libs/di/test && coveralls.sh; fi

branches:
  only:
    - master

notifications:
  recipients:
    - krzysztof@jusiak.net
  email:
    on_success: change
    on_failure: always

